datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  USER
  ADMIN
}

enum KycStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PaymentMethodType {
  MOMO
  BANK
  PAYPAL
  OTHER
}

enum OfferStatus {
  ACTIVE
  PAUSED
  CANCELLED
  COMPLETED
}

enum TradeStatus {
  PENDING_PAYMENT
  BUYER_MARKED_PAID
  SELLER_CONFIRMED_RECEIPT
  RELEASED
  DISPUTED
  CANCELLED
}

enum EscrowStatus {
  LOCKED
  RELEASED
  REFUNDED
}

enum DisputeStatus {
  OPEN
  RESOLVED_BUYER
  RESOLVED_SELLER
  RESOLVED_OTHER
  CLOSED
}

enum EvidenceType {
  SCREENSHOT
  RECEIPT
  OTHER
}

// ---------- USER & AUTH ----------

model User {
  id                  String   @id @default(cuid())
  email               String?  @unique
  phone               String?  @unique
  passwordHash        String
  role                UserRole @default(USER)
  isVerified          Boolean  @default(false) // separate from KYC
  rating              Float    @default(0)
  completedTradeCount Int      @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  profile         UserProfile?
  kyc             Kyc?
  paymentMethods  PaymentMethod[]
  offers          Offer[]         @relation("UserOffers")
  tradesAsMaker   Trade[]         @relation("TradesAsMaker")
  tradesAsTaker   Trade[]         @relation("TradesAsTaker")
  ratingsGiven    Rating[]        @relation("RatingsGiven")
  ratingsReceived Rating[]        @relation("RatingsReceived")
  disputesRaised  Dispute[]       @relation("DisputesRaised")
  messagesSent    Message[]       @relation("UserMessages")
}

model UserProfile {
  id                String  @id @default(cuid())
  user              User    @relation(fields: [userId], references: [id])
  userId            String  @unique
  fullName          String?
  country           String?
  preferredCurrency String?
  avatarUrl         String?
}

// ---------- KYC ----------

model Kyc {
  id               String    @id @default(cuid())
  user             User      @relation(fields: [userId], references: [id])
  userId           String    @unique
  documentType     String
  documentNumber   String
  documentFrontUrl String
  documentBackUrl  String
  selfieUrl        String?
  status           KycStatus @default(PENDING)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

// ---------- PAYMENT METHODS ----------

model PaymentMethod {
  id        String            @id @default(cuid())
  user      User              @relation(fields: [userId], references: [id])
  userId    String
  type      PaymentMethodType
  label     String
  details   Json // e.g. momoNumber, bankName, accountName, etc.
  isDefault Boolean           @default(false)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
}

// ---------- OFFERS ----------

model Offer {
  id                     String      @id @default(cuid())
  maker                  User        @relation("UserOffers", fields: [makerUserId], references: [id])
  makerUserId            String
  side                   String // "BUY" or "SELL" (string for flexibility)
  fromCurrency           String // e.g. "GHS", "USD"
  toCurrency             String
  rate                   Decimal     @db.Decimal(18, 8)
  minAmount              Decimal     @db.Decimal(18, 2)
  maxAmount              Decimal     @db.Decimal(18, 2)
  status                 OfferStatus @default(ACTIVE)
  paymentMethodsAccepted Json // list of payment method types or IDs
  createdAt              DateTime    @default(now())
  updatedAt              DateTime    @updatedAt

  trades Trade[]
}

// ---------- TRADES & ESCROW ----------

model Trade {
  id          String @id @default(cuid())
  offer       Offer  @relation(fields: [offerId], references: [id])
  offerId     String
  maker       User   @relation("TradesAsMaker", fields: [makerUserId], references: [id])
  makerUserId String
  taker       User   @relation("TradesAsTaker", fields: [takerUserId], references: [id])
  takerUserId String

  fromCurrency String
  toCurrency   String
  fromAmount   Decimal @db.Decimal(18, 2)
  toAmount     Decimal @db.Decimal(18, 2)

  status       TradeStatus  @default(PENDING_PAYMENT)
  escrowStatus EscrowStatus @default(LOCKED)
  expiresAt    DateTime?

  platformFeeAmount   Decimal? @db.Decimal(18, 2)
  platformFeeCurrency String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  dispute  Dispute?
  ratings  Rating[]
  messages Message[]
}

// ---------- DISPUTES ----------

model Dispute {
  id             String        @id @default(cuid())
  trade          Trade         @relation(fields: [tradeId], references: [id])
  tradeId        String        @unique
  raisedBy       User          @relation("DisputesRaised", fields: [raisedByUserId], references: [id])
  raisedByUserId String
  reason         String
  description    String?
  status         DisputeStatus @default(OPEN)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  evidence DisputeEvidence[]
}

model DisputeEvidence {
  id        String       @id @default(cuid())
  dispute   Dispute      @relation(fields: [disputeId], references: [id])
  disputeId String
  fileUrl   String
  type      EvidenceType @default(OTHER)
  createdAt DateTime     @default(now())
}

// ---------- MESSAGES ----------

model Message {
  id        String   @id @default(cuid())
  trade     Trade    @relation(fields: [tradeId], references: [id])
  tradeId   String
  sender    User     @relation("UserMessages", fields: [senderId], references: [id])
  senderId  String
  content   String
  createdAt DateTime @default(now())
}

// ---------- RATINGS ----------

model Rating {
  id          String   @id @default(cuid())
  trade       Trade    @relation(fields: [tradeId], references: [id])
  tradeId     String
  rater       User     @relation("RatingsGiven", fields: [raterUserId], references: [id])
  raterUserId String
  rated       User     @relation("RatingsReceived", fields: [ratedUserId], references: [id])
  ratedUserId String
  score       Int
  comment     String?
  createdAt   DateTime @default(now())

  @@unique([tradeId, raterUserId]) // one rating per trade per person
}
